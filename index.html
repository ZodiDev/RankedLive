<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCSR Ranked Top 50</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #050505; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        
        /* Glassmorphism */
        .glass { background: rgba(20, 20, 25, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-live { background: linear-gradient(90deg, rgba(69, 10, 10, 0.4) 0%, rgba(20, 20, 25, 0.9) 100%); border: 1px solid rgba(239, 68, 68, 0.5); }
        .glass-match { background: linear-gradient(90deg, rgba(6, 78, 59, 0.4) 0%, rgba(20, 20, 25, 0.9) 100%); border: 1px solid rgba(52, 211, 153, 0.5); }
        
        /* Hover Effects */
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -10px rgba(0,0,0,0.5); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-500 tracking-tighter">
                    MCSR RANKED
                </h1>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-[0.2em] mt-1">Live Top 50 Tracker</p>
            </div>
            
            <div id="loading-status" class="flex items-center gap-3 bg-slate-900 px-4 py-2 rounded-full border border-slate-800 shadow-lg">
                <div class="w-3 h-3 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="text-[10px] font-bold text-slate-400 uppercase">Syncing Leaderboard...</span>
            </div>
        </header>

        <div id="progress-container" class="w-full bg-slate-900/50 rounded-full h-1 mb-6 overflow-hidden">
            <div id="progress-bar" class="bg-emerald-500 h-1 transition-all duration-300 shadow-[0_0_10px_rgba(16,185,129,0.5)]" style="width: 0%"></div>
        </div>

        <div id="player-grid" class="space-y-3"></div>
    </div>

    <script>
        // --- YOUR CREDENTIALS ---
        const TWITCH_CLIENT_ID = "ctm7kgssic70d4ck6rjch5frhy4ux7"; 
        const TWITCH_ACCESS_TOKEN = "i1prbq87h8rurto7tacl3iet72gtyq";
        // ------------------------

        const API_RANKED = "https://api.mcsrranked.com/leaderboard";
        const API_USER_BASE = "https://api.mcsrranked.com/users/";
        const API_MATCHES_LIVE = "https://api.mcsrranked.com/live";

        async function init() {
            updateStatus("Fetching Leaderboard...", 10);
            
            try {
                // 1. Fetch Leaderboard AND Active Matches Parallel
                const [lbResp, liveResp] = await Promise.all([
                    fetch(API_RANKED),
                    fetch(API_MATCHES_LIVE)
                ]);

                const lbJson = await lbResp.json();
                const liveJson = await liveResp.json();
                
                let rawList = [];
                if (lbJson.data && Array.isArray(lbJson.data)) rawList = lbJson.data;
                else if (lbJson.data?.users && Array.isArray(lbJson.data.users)) rawList = lbJson.data.users;
                
                // Process Active Matches
                const activeUUIDs = new Set();
                if (liveJson.status === "success" && liveJson.data?.liveMatches) {
                    liveJson.data.liveMatches.forEach(match => {
                        match.players.forEach(p => activeUUIDs.add(p.uuid));
                    });
                }
                
                if (rawList.length === 0) throw new Error("Leaderboard API empty.");

                // 2. Process Top 50
                const top50 = rawList.slice(0, 50).map((p, index) => ({
                    ...p,
                    trueRank: index + 1,
                    inMatch: activeUUIDs.has(p.uuid) // Set initial match status
                }));

                // 3. Fetch details
                updateStatus("Checking Profiles...", 30);
                let playersData = await fetchAllProfiles(top50);

                // 4. Check Twitch Live Status
                updateStatus("Checking Streams...", 80);
                playersData = await checkTwitchLiveStatus(playersData);

                // 5. Sort Priorities:
                // 1. Is Live on Twitch OR In Match -> Top
                // 2. Elo -> Descending
                playersData.sort((a, b) => {
                    const aActive = a.isLive || a.inMatch;
                    const bActive = b.isLive || b.inMatch;
                    
                    if (aActive !== bActive) return bActive - aActive;
                    return b.elo - a.elo;
                });

                render(playersData);
                updateStatus("Data Active", 100, true);

            } catch (err) {
                console.error(err);
                document.getElementById('player-grid').innerHTML = `
                    <div class="p-8 text-center border border-red-900/50 bg-red-900/10 rounded-xl">
                        <p class="text-red-400 font-bold mb-2">System Error</p>
                        <p class="text-xs text-slate-500 font-mono">${err.message}</p>
                    </div>`;
            }
        }

        async function fetchAllProfiles(basicPlayers) {
            // Helper to fetch one profile
            const fetchOne = async (player) => {
                try {
                    const profileResp = await fetch(`${API_USER_BASE}${player.uuid}`);
                    const pJson = await profileResp.json();
                    
                    const profile = pJson.data || {};
                    const twitchName = profile.connections?.twitch?.name || profile.connections?.twitch || null;
                    
                    return {
                        rank: player.trueRank,
                        uuid: player.uuid,
                        name: player.nickname,
                        elo: player.eloRate,
                        twitch: twitchName,
                        hasTwitch: !!twitchName,
                        isLive: false,
                        inMatch: player.inMatch // Preserve valid match status
                    };
                } catch (e) {
                    // Fallback
                    return {
                        rank: player.trueRank,
                        uuid: player.uuid,
                        name: player.nickname,
                        elo: player.eloRate,
                        twitch: null,
                        hasTwitch: false,
                        isLive: false,
                        inMatch: player.inMatch
                    };
                }
            };

            // Run in parallel with progress
            let completed = 0;
            const promises = basicPlayers.map(p => fetchOne(p).then(res => {
                completed++;
                document.getElementById('progress-bar').style.width = `${30 + ((completed / 50) * 50)}%`;
                return res;
            }));

            return Promise.all(promises);
        }

        async function checkTwitchLiveStatus(players) {
            const streamers = players.filter(p => p.twitch);
            if (streamers.length === 0) return players;

            const query = streamers.map(p => `user_login=${p.twitch}`).join('&');
            
            try {
                const resp = await fetch(`https://api.twitch.tv/helix/streams?${query}`, {
                    headers: {
                        'Client-ID': TWITCH_CLIENT_ID,
                        'Authorization': `Bearer ${TWITCH_ACCESS_TOKEN}`
                    }
                });
                
                if (!resp.ok) return players;
                
                const data = await resp.json();
                const liveStreams = data.data || [];
                
                return players.map(p => {
                    const isLive = liveStreams.some(s => s.user_login.toLowerCase() === p.twitch?.toLowerCase());
                    return { ...p, isLive };
                });
            } catch (e) {
                return players;
            }
        }

        function openStream(username) {
            if (!username) return;
            
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Try deep link first, fallback handled by OS usually, but we can try to force it
                window.location.href = `twitch://open?stream=${username}`;
                
                // Optional: Fallback to web if app doesn't open (often requires timeout hack, but simpler is better first)
                setTimeout(() => {
                    window.open(`https://m.twitch.tv/${username}`, '_blank');
                }, 500);
            } else {
                window.open(`https://twitch.tv/${username}`, '_blank');
            }
        }

        function render(list) {
            const container = document.getElementById('player-grid');
            container.innerHTML = '';

            list.forEach((p) => {
                // Dynamic styling
                let classes = "card-hover flex items-center justify-between p-4 rounded-xl transition-all duration-200 group relative overflow-hidden ";
                
                // Prioritize Twitch Live style, fallback to Match style, else standard
                if (p.isLive) {
                    classes += "glass-live cursor-pointer";
                } else if (p.inMatch) {
                    classes += "glass-match cursor-default"; // Green/Cyan tint for match only
                } else if (p.hasTwitch) {
                    classes += "glass cursor-pointer hover:bg-slate-800/80 hover:border-purple-500/30";
                } else {
                    classes += "glass cursor-default opacity-80";
                }

                // Change tag based on twitch availability, but handle click manually for streams
                const tag = p.hasTwitch ? 'div' : 'div';
                const clickAttr = p.hasTwitch ? `onclick="openStream('${p.twitch}')"` : '';

                const html = `
                <${tag} ${clickAttr} class="${classes}">
                    
                    <div class="flex items-center gap-5 z-10">
                        <div class="w-8 text-center">
                            <span class="font-black text-xl italic ${p.rank <= 3 ? 'text-yellow-400 drop-shadow-md' : 'text-slate-600'}">
                                #${p.rank}
                            </span>
                        </div>
                        
                        <div class="relative">
                            <img src="https://mc-heads.net/avatar/${p.uuid}/48" class="w-12 h-12 rounded-lg shadow-lg bg-slate-900 object-cover">
                            
                            ${p.isLive ? `
                                <span class="absolute -top-1.5 -right-1.5 flex h-4 w-4">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-4 w-4 bg-red-600 border-2 border-[#0f172a]"></span>
                                </span>
                            ` : ''}
                        </div>

                        <div class="flex flex-col">
                            <span class="font-bold text-slate-100 text-lg group-hover:text-white transition-colors flex items-center gap-2">
                                ${p.name}
                                
                                ${p.isLive ? '<span class="text-[10px] bg-red-600 text-white px-1.5 rounded font-bold tracking-wider animate-pulse">LIVE</span>' : ''}
                                
                                ${p.inMatch ? '<span class="text-[10px] bg-cyan-600 text-white px-1.5 rounded font-bold tracking-wider shadow-[0_0_10px_rgba(8,145,178,0.5)]">IN MATCH</span>' : ''}
                            </span>

                            ${p.hasTwitch ? 
                                `<span class="text-xs font-mono font-medium ${p.isLive ? 'text-red-300' : 'text-purple-400 group-hover:text-purple-300'} transition-colors">
                                    <i class="fab fa-twitch mr-1"></i>${p.twitch}
                                 </span>` 
                                : 
                                `<span class="text-xs text-slate-600 font-mono">No Stream Linked</span>`
                            }
                        </div>
                    </div>

                    <div class="text-right z-10">
                        <div class="text-2xl font-black text-emerald-400 tracking-tighter group-hover:scale-105 transition-transform origin-right">
                            ${p.elo}
                        </div>
                        <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">ELO RATING</div>
                    </div>

                    ${p.hasTwitch ? `<div class="absolute inset-0 bg-purple-600/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>` : ''}

                </${tag}>
                `;
                
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function updateStatus(msg, percent, complete = false) {
            const bar = document.getElementById('progress-bar');
            const text = document.querySelector('#loading-status span');
            const spinner = document.querySelector('#loading-status div');
            
            bar.style.width = `${percent}%`;
            text.innerText = msg;
            
            if (complete) {
                spinner.className = "w-3 h-3 bg-emerald-500 rounded-full shadow-[0_0_10px_#10b981]";
                setTimeout(() => {
                    document.getElementById('progress-container').style.opacity = '0';
                }, 1500);
            }
        }

        init();
    </script>
</body>
</html>
